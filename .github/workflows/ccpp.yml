name: C/C++ CI

on: [push, pull_request]
env:
   TRAVIS: true
   NUM_JOBS: 10

jobs:
  unit_and_style:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: check style
      run:  make compliant && make shellcheck && make docs-coverage

    - name: check install
      run:  sudo make install && make install-check

    - name: run unit tests
      run:  make check

    - name: run distcheck
      run:  make distcheck

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job1:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 1
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job2:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 2
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job3:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 3
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job4:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 4
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job5:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 5
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job6:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 6
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job7:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 7
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job8:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 8
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job9:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 9
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log

  test_job10:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
       JOB_NUMBER: 10
    steps:
    - uses: actions/checkout@v1

    - name: build
      run:  scripts/build_ci.bash

    - name: Run prereq
      run:  test/functional/generate-cert.prereq

    - name: run check
      run: |
            FILES="$(scripts/filter_bats_list.sh $JOB_NUMBER $NUM_JOBS)"
            env TESTS="$FILES" make -e -j2 check

    - name: print status
      if: failure()
      run: cat test-suite.log
